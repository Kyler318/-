<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ«æ—¥ä»£ç¢¼ï¼šé‚è¼¯æ·±æ½› (Expert Mode)</title>
    <style>
        /* --- 0. å…¨å±€è¨­å®š --- */
        :root {
            --bg-color: #0b0c15;
            --panel-bg: #151725;
            --border: #2a2d3e;
            --cyan: #00f0ff;
            --purple: #bd00ff;
            --green: #00ff9f;
            --yellow: #fce300;
            --red: #ff2a2a;
            --text: #e0e6ed;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            font-family: 'Segoe UI', 'Consolas', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0; height: 100vh; display: flex; overflow: hidden;
        }

        /* --- 1. å·¦å´ç·¨è¼¯å€ --- */
        .editor-panel {
            width: 50%; background: var(--panel-bg); border-right: 2px solid var(--border);
            display: flex; flex-direction: column;
        }
        
        .header {
            padding: 15px; background: #0f101a; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .title { color: var(--cyan); font-weight: bold; letter-spacing: 1.5px; }
        .level-badge { background: #222; padding: 5px 10px; border-radius: 4px; color: var(--yellow); font-size: 0.9rem; }

        .workspace {
            flex: 1; padding: 30px; overflow-y: auto;
            background-image: radial-gradient(#23263a 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .main-loop {
            border: 3px solid var(--yellow); border-radius: 10px;
            background: rgba(252, 227, 0, 0.05);
            min-height: 250px; padding: 45px 15px 15px 15px;
            position: relative; display: flex; flex-direction: column; gap: 10px;
        }
        .main-loop-label {
            position: absolute; top: 0; left: 0; background: var(--yellow); color: #000;
            font-weight: bold; padding: 5px 15px; border-bottom-right-radius: 10px;
        }

        /* --- ç©æœ¨èˆ‡åˆ†æ”¯æ¨£å¼ --- */
        .block-struct {
            border-radius: 8px; padding: 5px; display: flex; flex-direction: column; gap: 2px;
            margin-bottom: 5px; border-left: 5px solid;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            transition: all 0.2s;
            position: relative;
        }
        .struct-if { background: #151922; border-color: var(--cyan); }
        .struct-while { background: #251a2e; border-color: var(--purple); padding: 8px; }

        .branch-row {
            display: flex; flex-direction: column; gap: 5px;
            padding: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        .branch-row:last-child { border-bottom: none; }

        .block-header { 
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem; 
            font-family: monospace; padding-bottom: 5px; position: relative;
        }
        
        .block-body {
            min-height: 50px; background: rgba(0,0,0,0.3); border-radius: 5px;
            padding: 8px; border: 1px dashed #444;
            display: flex; flex-direction: column; gap: 8px;
        }
        .block-body.drag-hover { background: rgba(255, 255, 255, 0.1); border-color: #fff; }

        .trash-btn { 
            margin-left: auto; cursor: pointer; color: #666; font-size: 1.2rem; font-weight: bold; padding: 2px 8px; position: relative; z-index: 10;
        }
        .trash-btn:hover { color: var(--red); background: rgba(255,0,0,0.1); border-radius: 4px; }

        .add-elif-btn {
            background: rgba(0, 240, 255, 0.1); border: 1px dashed var(--cyan); color: var(--cyan);
            padding: 5px; cursor: pointer; text-align: center; font-size: 0.8rem; border-radius: 4px;
            margin: 5px; transition: 0.2s;
        }
        .add-elif-btn:hover { background: rgba(0, 240, 255, 0.2); }

        .slot {
            display: inline-flex; min-width: 110px; height: 32px;
            background: #000; border: 1px dashed #555; border-radius: 4px;
            align-items: center; justify-content: center; color: #666; font-size: 0.8rem;
            padding: 0 10px;
        }
        .slot.drag-hover { border-color: var(--green); background: rgba(0, 255, 159, 0.1); }
        .slot.filled { border-style: solid; border-color: #888; }

        .toolbox { height: 200px; background: #0f101a; border-top: 2px solid var(--border); display: flex; flex-direction: column; }
        .tabs { display: flex; background: #000; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; border-bottom: 3px solid transparent; }
        .tab.active { color: #fff; border-bottom-color: var(--cyan); background: #1a1d2b; }
        .tools-content { flex: 1; display: none; padding: 15px; overflow-x: auto; gap: 15px; align-items: center; }
        .tools-content.active { display: flex; }

        .chip {
            padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: grab;
            display: flex; align-items: center; gap: 8px; white-space: nowrap; font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        .chip:active { transform: scale(0.95); cursor: grabbing; }
        .c-flow { background: #2a2d3e; color: #fff; border-color: #fff; }
        .c-sensor { background: #0d2829; color: var(--cyan); border-color: var(--cyan); }
        .c-action { background: #2b111a; color: var(--red); border-color: var(--red); }

        /* --- å³å´ --- */
        .stage { width: 50%; background: #000; display: flex; flex-direction: column; position: relative; }
        .view-port { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        .scanner-frame {
            width: 100px; height: 100px; border: 3px solid var(--green); border-radius: 15px;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; pointer-events: none;
            box-shadow: 0 0 30px rgba(0, 255, 159, 0.2);
            background: rgba(0, 255, 159, 0.05);
            display: flex; justify-content: center; align-items: center;
        }
        .drone-icon { font-size: 3.5rem; filter: drop-shadow(0 0 10px var(--green)); position: relative; top: -5px; }
        
        .belt {
            position: absolute; top: 50%; left: 50%; 
            margin-top: -40px; margin-left: -40px; 
            display: flex; gap: 20px;
            transition: transform 0.4s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .cell {
            width: 80px; height: 80px;
            background: #111; border: 2px solid #333; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; position: relative; flex-shrink: 0;
        }
        
        .hp-bar { position: absolute; top: -15px; left: 0; width: 100%; height: 6px; background: #333; display: none; border-radius: 3px; overflow: hidden; }
        .hp-val { width: 100%; height: 100%; background: var(--red); transition: width 0.2s; }
        .status-badge { position: absolute; bottom: -10px; right: -10px; font-size: 1rem; background: #000; border-radius: 50%; padding: 2px; }

        .console {
            height: 160px; background: #08080c; border-top: 1px solid #333; padding: 15px;
            font-family: 'Consolas', monospace; font-size: 0.9rem; color: #888; overflow-y: auto;
        }
        .log-line { margin-bottom: 5px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .l-ok { color: var(--green); } .l-err { color: var(--red); } .l-warn { color: var(--yellow); }

        .controls { padding: 15px; display: flex; gap: 10px; background: #0f101a; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .btn-run { background: var(--cyan); color: #000; }
        .btn-run:hover { background: #fff; box-shadow: 0 0 15px var(--cyan); }
        .btn-reset { background: #333; color: #fff; }

        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal { background: #151725; border: 2px solid var(--cyan); padding: 40px; border-radius: 15px; max-width: 700px; width: 90%; text-align: center; box-shadow: 0 0 50px rgba(0, 240, 255, 0.2); }
        .modal h2 { color: var(--cyan); font-size: 1.8rem; margin-top: 0; }
        .modal-content { text-align: left; margin: 20px 0; color: #ddd; font-size: 1.1rem; line-height: 1.6; }
        .concept-box { background: rgba(0, 240, 255, 0.1); padding: 15px; border-left: 4px solid var(--cyan); margin: 15px 0; }
    </style>
</head>
<body>

<div id="modal" class="modal-mask">
    <div class="modal">
        <h2 id="m-title">ä»»å‹™ç°¡å ±</h2>
        <div id="m-content" class="modal-content"></div>
        <button class="btn btn-run" onclick="closeModal()" style="margin-top:20px; width: 200px;">æ”¶åˆ°ï¼Œé–‹å§‹ä»»å‹™</button>
    </div>
</div>

<div class="editor-panel">
    <div class="header">
        <div class="title">DRONE COMMAND // é‚è¼¯æ·±æ½› (Expert)</div>
        <div class="level-badge" id="lvl-display">Level 1</div>
    </div>
    
    <div class="workspace">
        <div class="main-loop" id="root-container" data-type="container">
            <div class="main-loop-label">MAIN LOOP (ç„¡é™é‡è¤‡)</div>
            <div id="hint-text" style="color:#555; text-align:center; padding-top:80px; pointer-events:none;">
                å°‡ [çµæ§‹ç©æœ¨] æ‹–æ›³è‡³æ­¤è™•<br>å»ºç«‹ä½ çš„é‚è¼¯æ¨¹
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div class="tabs">
            <div class="tab active" onclick="setTab('struct')">1. çµæ§‹ (Flow)</div>
            <div class="tab" onclick="setTab('sensor')">2. æ„Ÿæ¸¬ (Inputs)</div>
            <div class="tab" onclick="setTab('action')">3. å‹•ä½œ (Outputs)</div>
        </div>
        
        <div class="tools-content active" id="t-struct"></div>
        <div class="tools-content" id="t-sensor"></div>
        <div class="tools-content" id="t-action"></div>
    </div>
</div>

<div class="stage">
    <div class="view-port">
        <div class="scanner-frame"><div class="drone-icon">ğŸ›¸</div></div>
        <div class="belt" id="belt"></div>
    </div>
    <div class="console" id="console">
        <div class="log-line">> System initialized...</div>
    </div>
    <div class="controls">
        <button class="btn btn-reset" onclick="resetLevel()">é‡ç½®ç³»çµ±</button>
        <button class="btn btn-run" onclick="runCode()">åŸ·è¡Œç¨‹å¼ (EXECUTE)</button>
    </div>
</div>

<script>
    // --- å„²å­˜æ©Ÿåˆ¶ Key ---
    const KEY_LEVEL = 'doom_level_idx';
    const KEY_CODE = 'doom_user_code';

    // --- é—œå¡æ•¸æ“š ---
    const LEVELS = [
        {
            id: 1, title: "L1: åŸºç¤åˆ¤æ–·",
            concept: "å·¥å…·ä»‹ç´¹ï¼šå¦‚æœ...å¦å‰‡...",
            desc: "å‰æ–¹é“è·¯ä¸Šæœ‰ <b>æµ®çŸ³(ğŸ—¿)</b> é˜»æ“‹ï¼Œä½ éœ€è¦è®“ç„¡äººæ©Ÿåšå‡ºæ­£ç¢ºçš„åæ‡‰ã€‚",
            detail: "<div class='concept-box'>ä½¿ç”¨ <b>å¦‚æœ (IF)</b> ç©æœ¨ä¾†æª¢æŸ¥æ„Ÿæ¸¬å™¨æ¢ä»¶ã€‚<br>ç•¶æ¢ä»¶æˆç«‹æ™‚ï¼ŒæœƒåŸ·è¡Œç©æœ¨å…§éƒ¨çš„å‹•ä½œï¼›<br>å¦‚æœæ¢ä»¶ä¸æˆç«‹ï¼Œå‰‡åŸ·è¡Œ <b>ELSE (å¦å‰‡)</b> å€å¡Šä¸­çš„å‹•ä½œã€‚</div>",
            map: [0, 1, 0, 1, 0, 0, 9], 
            tools: { struct:['if'], sensor:['rock'], action:['move','jump'] }
        },
        {
            id: 2, title: "L2: å¤šåˆ†æ”¯åˆ¤æ–·",
            concept: "å·¥å…·ä»‹ç´¹ï¼šå¦å‰‡å¦‚æœ (Else If)",
            desc: "é€™æ¬¡é™¤äº†æµ®çŸ³ï¼Œé‚„æœ‰ <b>æ•µæ©Ÿ(ğŸ‘¾)</b>ï¼<br>é‡åˆ°æ•µæ©Ÿéœ€è¦æ”»æ“Šï¼Œé‡åˆ°æµ®çŸ³éœ€è¦è·³èºã€‚",
            detail: "<div class='concept-box'>ç•¶æƒ…æ³ä¸æ­¢ä¸€ç¨®æ™‚ï¼Œé»æ“Š <b>[+å¦å‰‡å¦‚æœ]</b> æŒ‰éˆ•å¢åŠ åˆ†æ”¯ã€‚<br>ç³»çµ±æœƒä¾åºæª¢æŸ¥ï¼š<br>1. æ˜¯ A æƒ…æ³å—ï¼Ÿ(åŸ·è¡Œ A å‹•ä½œ)<br>2. å¦å‰‡ï¼Œæ˜¯ B æƒ…æ³å—ï¼Ÿ(åŸ·è¡Œ B å‹•ä½œ)<br>3. éƒ½ä¸æ˜¯ï¼Ÿ(åŸ·è¡Œ ELSE å‹•ä½œ)</div>",
            map: [0, 2, 0, 1, 2, 0, 9], 
            tools: { struct:['if'], sensor:['rock','enemy'], action:['move','jump','laser'] }
        },
        {
            id: 3, title: "L3: é¡è‰²è¾¨è­˜",
            concept: "å·¥å…·ä»‹ç´¹ï¼šæ„Ÿæ¸¬å™¨åŒ¹é…",
            desc: "å‰æ–¹æœ‰ <b>ç´…é–€(ğŸ”´)</b> èˆ‡ <b>è—é–€(ğŸ”µ)</b>ï¼Œå¿…é ˆä½¿ç”¨å°æ‡‰é¡è‰²çš„é‘°åŒ™å¡æ‰èƒ½é€šéã€‚",
            detail: "<div class='concept-box'>æ„Ÿæ¸¬å™¨ç¾åœ¨å¯ä»¥å€åˆ†ä¸åŒé¡å‹çš„ç‰©ä»¶äº†ã€‚<br>è«‹è§€å¯Ÿæ„Ÿæ¸¬å™¨æ¸…å–®ï¼Œç¢ºä¿ä½ çš„ã€Œæ¢ä»¶ã€(å¦‚ï¼šç´…é–€) èˆ‡ä½ çš„ã€Œå‹•ä½œã€(å¦‚ï¼šä½¿ç”¨ç´…å¡) æ˜¯æ­£ç¢ºå°æ‡‰çš„ã€‚</div>",
            map: [0, 3, 0, 4, 3, 0, 9],
            tools: { struct:['if'], sensor:['door_r','door_b'], action:['move','key_r','key_b'] }
        },
        {
            id: 4, title: "L4: è¤‡åˆåˆ¤æ–· (å·¢ç‹€)",
            concept: "å·¥å…·ä»‹ç´¹ï¼šå·¢ç‹€çµæ§‹ (Nesting)",
            desc: "<b>æ•µæ©Ÿå‡ç´šäº†ï¼</b> éƒ¨åˆ†æ•µæ©Ÿæ“æœ‰ <b>è­·ç›¾(ğŸ›¡ï¸)</b>ã€‚<br>é›·å°„ç„¡æ³•ç©¿é€è­·ç›¾ï¼Œå¿…é ˆå…ˆç”¨ EMP ç ´ç›¾ã€‚",
            detail: "<div class='concept-box'><b>é‚è¼¯ç©æœ¨æ˜¯å¯ä»¥ã€Œå±¤å±¤åŒ…è£¹ã€çš„ï¼</b><br>ä½ å¯ä»¥åœ¨ã€Œå¦‚æœç™¼ç¾æ•µäººã€çš„ç©æœ¨å…§éƒ¨ï¼Œå†æ”¾å…¥å¦ä¸€å€‹ã€Œå¦‚æœã€ç©æœ¨ï¼Œç”¨ä¾†æª¢æŸ¥è©²æ•µäººæ˜¯å¦æœ‰è­·ç›¾ã€‚<br>æç¤ºï¼šEMP åªèƒ½ç§»é™¤è­·ç›¾ï¼Œä¸æœƒæ‘§æ¯€æ•µæ©Ÿã€‚</div>",
            map: [0, {t:2, s:true}, {t:2, s:false}, 0, {t:2, s:true}, 9],
            tools: { struct:['if'], sensor:['enemy','shield'], action:['move','laser','emp'] }
        },
        {
            id: 5, title: "L5: å¾ªç’°æŒ‘æˆ°",
            concept: "å·¥å…·ä»‹ç´¹ï¼šå¾ªç’°ç›´åˆ° (While Loop)",
            desc: "å‰æ–¹å‡ºç¾ <b>å·¨å‹éš•çŸ³(â˜„ï¸)</b>ï¼Œå®ƒçš„è£ç”²å¾ˆåš (HP=3)ï¼Œå–®æ¬¡é›·å°„ç„¡æ³•æ¸…é™¤ã€‚",
            detail: "<div class='concept-box'>ä½¿ç”¨ <b>å¾ªç’°ç›´åˆ° (WHILE)</b> ç©æœ¨ã€‚<br>åªè¦æ¢ä»¶æˆç«‹ (ä¾‹å¦‚ï¼šéšœç¤™ç‰©é‚„å­˜åœ¨)ï¼Œå®ƒå°±æœƒä¸æ–·é‡è¤‡åŸ·è¡Œå…§éƒ¨çš„å‹•ä½œï¼Œç›´åˆ°éšœç¤™è¢«æ¸…é™¤ç‚ºæ­¢ã€‚</div>",
            map: [0, {t:5, hp:3}, 0, {t:5, hp:2}, 0, 9],
            tools: { struct:['if','while'], sensor:['rock','clear'], action:['move','laser'] }
        },
        {
            id: 6, title: "L6: é‡è£æ©Ÿç”²",
            concept: "æŒ‘æˆ°ï¼šå·¢ç‹€ + å¾ªç’° (Nested Loop)",
            desc: "<b>è­¦å‘Šï¼</b> åµæ¸¬åˆ°é‡è£æ•µæ©Ÿ (ğŸ›¡ï¸ + HP=3)ã€‚<br>ä½ éœ€è¦å…ˆç ´é™¤è­·ç›¾ï¼Œç„¶å¾ŒæŒçºŒæ”»æ“Šç›´åˆ°æ‘§æ¯€å®ƒã€‚",
            detail: "<div class='concept-box'><b>æ€è€ƒæ¨¡å¼ï¼š</b><br>1. å¦‚æœ(æ•µäºº) -> å¦‚æœ(è­·ç›¾) { EMP } å¦å‰‡ { å¾ªç’°ç›´åˆ°(æ•µäºº) { é›·å°„ } }<br>2. é€™æ¨£å¯ä»¥ç¢ºä¿å…ˆç ´ç›¾ï¼Œä¸‹ä¸€è¼ªå†é€²å…¥ç„¡ç›¡çš„é›·å°„æ”»æ“Šã€‚</div>",
            map: [0, {t:2, s:true, hp:3}, 0, {t:2, s:false, hp:2}, 0, 9],
            tools: { struct:['if','while'], sensor:['enemy','shield'], action:['move','laser','emp'] }
        },
        {
            id: 7, title: "L7: é‚è¼¯é–˜é“",
            concept: "æŒ‘æˆ°ï¼šå¤šé‡åˆ†æ”¯ + å¾ªç’°",
            desc: "è¤‡åˆåœ°å½¢å€ï¼šåŒ…å«ç´…é–€(ğŸ”´)ã€é«˜å¼·åº¦éš•çŸ³(â˜„ï¸)èˆ‡æ™®é€šç©ºåŸŸã€‚",
            detail: "<div class='concept-box'>ä½ éœ€è¦æ§‹å»ºä¸€å€‹è¤‡é›œçš„åˆ¤æ–·æ¨¹ï¼š<br>å¦‚æœæ˜¯ç´…é–€ -> é–‹é–€<br>å¦å‰‡å¦‚æœæ˜¯éšœç¤™ -> å¾ªç’°æ”»æ“Š<br>å¦å‰‡ -> å‰é€²</div>",
            map: [0, 3, {t:5, hp:3}, 0, 3, {t:5, hp:2}, 9],
            tools: { struct:['if','while'], sensor:['rock','door_r','clear'], action:['move','laser','key_r'] }
        },
        {
            id: 8, title: "L8: æœ«æ—¥æ ¸å¿ƒ",
            concept: "æŒ‘æˆ°ï¼šçµ‚æ¥µé‚è¼¯ (Ultimate Logic)",
            desc: "<b>æœ€çµ‚æ¸¬è©¦ï¼š</b> é‡è£æ•µæ©Ÿ(ğŸ›¡ï¸)ã€å·¨å‹éš•çŸ³(â˜„ï¸)ã€ç´…é–€(ğŸ”´) åŒæ™‚å‡ºç¾ã€‚",
            detail: "<div class='concept-box'>ä½ éœ€è¦çµåˆç›®å‰ç‚ºæ­¢å­¸åˆ°çš„æ‰€æœ‰æŠ€å·§ï¼š<br>å¤šé‡åˆ¤æ–· (Else If)ã€å·¢ç‹€åˆ¤æ–· (Nested If)ã€ä»¥åŠå¾ªç’° (While)ã€‚<br>ç¥ä½ å¥½é‹ï¼ŒæŒ‡æ®å®˜ã€‚</div>",
            map: [0, {t:2, s:true, hp:3}, 3, {t:5, hp:3}, {t:2, s:false, hp:2}, 9],
            tools: { struct:['if','while'], sensor:['enemy','rock','door_r','shield','clear'], action:['move','laser','emp','key_r'] }
        }
    ];

    const OBJ = {
        0: { ch:' ', name:'ç©ºåŸŸ' },
        1: { ch:'ğŸ—¿', name:'æµ®çŸ³' },
        2: { ch:'ğŸ‘¾', name:'æ•µæ©Ÿ' },
        3: { ch:'ğŸšª', name:'ç´…é–€', style:'border-color:red; color:red' },
        4: { ch:'ğŸšª', name:'è—é–€', style:'border-color:cyan; color:cyan' },
        5: { ch:'â˜„ï¸', name:'å·¨çŸ³' },
        9: { ch:'ğŸ', name:'åŸºåœ°' }
    };

    const TEXT_MAP = {
        'if':'å¦‚æœ (IF)', 'while':'å¾ªç’° (WHILE)',
        'rock':'éšœç¤™', 'enemy':'æ•µæ©Ÿ', 'shield':'è­·ç›¾', 'door_r':'ç´…é–€', 'door_b':'è—é–€', 'clear':'éšœç¤™å­˜åœ¨',
        'move':'å‰é€²', 'jump':'è·³èº', 'laser':'é›·å°„', 'emp':'EMP', 'key_r':'ç´…å¡', 'key_b':'è—å¡'
    };

    let curLvlIdx = 0;
    let runtimeMap = [];
    let isRunning = false;
    let autoSaveObserver = null;
    let activeExecId = 0; // [æ–°å¢] ç”¨æ–¼æ§åˆ¶ç¨‹å¼çµ‚æ­¢çš„å”¯ä¸€ ID

    // --- åˆå§‹åŒ–èˆ‡è‡ªå‹•è®€å– ---
    window.onload = () => {
        const savedLevel = localStorage.getItem(KEY_LEVEL);
        const savedCode = localStorage.getItem(KEY_CODE);
        
        if (savedLevel !== null) {
            curLvlIdx = parseInt(savedLevel);
            loadLevel(curLvlIdx, true); 
            if (savedCode && savedCode.trim() !== "") {
                const root = document.getElementById('root-container');
                root.innerHTML = savedCode;
                restoreListeners(root); 
            }
            log(`å·²æ¢å¾©ä¸Šæ¬¡é€²åº¦ï¼šé—œå¡ ${curLvlIdx+1}`);
        } else {
            loadLevel(0);
        }

        initAutoSave();
    };

    function initAutoSave() {
        const root = document.getElementById('root-container');
        if(autoSaveObserver) autoSaveObserver.disconnect();
        
        autoSaveObserver = new MutationObserver(() => {
            localStorage.setItem(KEY_CODE, root.innerHTML);
        });
        
        autoSaveObserver.observe(root, { childList: true, subtree: true, attributes: true, characterData: true });
    }

    function restoreListeners(container) {
        container.querySelectorAll('.slot').forEach(slot => {
            delete slot.dataset.init; 
        });
        container.querySelectorAll('.block-struct, .branch-row').forEach(block => setupSlots(block));
    }

    function loadLevel(idx, preserveCode = false) {
        curLvlIdx = idx;
        localStorage.setItem(KEY_LEVEL, curLvlIdx); 

        const d = LEVELS[idx];
        document.getElementById('lvl-display').innerText = d.title;
        document.getElementById('m-title').innerText = d.title;
        document.getElementById('m-content').innerHTML = `<h3>${d.concept}</h3><p>${d.desc}</p>${d.detail}`;
        document.getElementById('modal').style.display = 'flex';
        renderToolbox(d.tools);
        
        runtimeMap = JSON.parse(JSON.stringify(d.map)).map(item => {
            return (typeof item === 'object') ? item : { t: item };
        });

        renderMap();
        
        if (!preserveCode) {
            document.getElementById('root-container').innerHTML = `
                <div class="main-loop-label">MAIN LOOP (ç„¡é™é‡è¤‡)</div>
                <div id="hint-text" style="color:#555; text-align:center; padding-top:80px; pointer-events:none;">
                    å°‡ [çµæ§‹ç©æœ¨] æ‹–æ›³è‡³æ­¤è™•<br>å»ºç«‹ä½ çš„é‚è¼¯æ¨¹
                </div>
            `;
            localStorage.setItem(KEY_CODE, document.getElementById('root-container').innerHTML);
        }
        
        log(`ç³»çµ±è¼‰å…¥é—œå¡ ${idx+1}...`);
    }

    function renderToolbox(tools) {
        const tStruct = document.getElementById('t-struct');
        const tSensor = document.getElementById('t-sensor');
        const tAction = document.getElementById('t-action');
        tStruct.innerHTML = ''; tSensor.innerHTML = ''; tAction.innerHTML = '';
        tools.struct.forEach(t => createTool(tStruct, 'struct', t));
        tools.sensor.forEach(t => createTool(tSensor, 'sensor', t));
        tools.action.forEach(t => createTool(tAction, 'action', t));
    }

    function createTool(container, type, val) {
        const div = document.createElement('div');
        let cls = type === 'struct' ? 'c-flow' : (type === 'sensor' ? 'c-sensor' : 'c-action');
        div.className = `chip ${cls}`; div.draggable = true;
        div.innerHTML = `<span>${TEXT_MAP[val]}</span>`;
        div.ondragstart = (e) => drag(e, type, val);
        container.appendChild(div);
    }

    function renderMap() {
        const belt = document.getElementById('belt');
        belt.innerHTML = ''; belt.style.transform = 'translateX(0px)';
        runtimeMap.forEach((obj, i) => {
            const type = (typeof obj === 'object') ? obj.t : obj;
            const div = document.createElement('div');
            div.className = 'cell'; div.id = `cell-${i}`;
            let content = OBJ[type].ch;
            let extras = '';
            if (OBJ[type].style) div.style = OBJ[type].style;
            if (typeof obj === 'object') {
                if (obj.s) extras += `<div class="status-badge">ğŸ›¡ï¸</div>`;
                if (obj.hp) extras += `<div class="hp-bar" style="display:block"><div class="hp-val" style="width:100%"></div></div>`;
            }
            div.innerHTML = `${extras}<div class="obj-vis">${content}</div>`;
            belt.appendChild(div);
        });
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function setTab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tools-content').forEach(e=>e.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('t-'+t).classList.add('active');
    }

    // --- æ‹–æ”¾ç³»çµ± ---
    function drag(ev, type, val) { ev.dataTransfer.setData("type", type); ev.dataTransfer.setData("val", val); ev.stopPropagation(); }

    document.addEventListener('dragover', (e) => {
        if (e.target.dataset.type === 'container') { e.preventDefault(); e.stopPropagation(); e.target.classList.add('drag-hover'); }
    });
    document.addEventListener('dragleave', (e) => {
        if (e.target.dataset.type === 'container') e.target.classList.remove('drag-hover');
    });
    document.addEventListener('drop', (e) => {
        if (e.target.dataset.type === 'container') {
            e.preventDefault(); e.stopPropagation(); e.target.classList.remove('drag-hover');
            handleDrop(e.target, e);
        }
    });

    window.removeNode = function(btn, event) {
        if (event) event.stopPropagation();

        const chip = btn.closest('.chip');
        if (chip) { chip.remove(); return; }

        const row = btn.closest('.branch-row');
        if (row) {
            if (row.dataset.branch === 'elseif') { row.remove(); return; }
        }

        const struct = btn.closest('.block-struct');
        if (struct) { struct.remove(); }
    }

    function handleDrop(container, e) {
        const type = e.dataTransfer.getData("type");
        const val = e.dataTransfer.getData("val");
        if (document.getElementById('hint-text')) document.getElementById('hint-text').style.display = 'none';

        if (type === 'struct') {
            const div = document.createElement('div');
            div.dataset.logic = val;
            if (val === 'if') {
                div.className = `block-struct struct-if`;
                div.innerHTML = `
                    <div class="branch-row" data-branch="if">
                        <div class="block-header">
                            <span style="color:var(--cyan)">ğŸ”· å¦‚æœ (IF)</span>
                            <div class="slot" data-accept="sensor">(æ¢ä»¶?)</div>
                            <span class="trash-btn" onclick="removeNode(this, event)">âœ–</span>
                        </div>
                        <div class="block-body" data-type="container"></div>
                    </div>
                    <div class="add-elif-btn" onclick="addElseIf(this)">â• å¦å‰‡å¦‚æœ (Else If)</div>
                    <div class="branch-row" data-branch="else">
                        <div class="block-header" style="color:#888">ELSE (å¦å‰‡)</div>
                        <div class="block-body" data-type="container"></div>
                    </div>
                `;
            } else {
                div.className = `block-struct struct-while`;
                div.innerHTML = `
                    <div class="block-header">
                        <span style="color:var(--purple)">ğŸ”‚ å¾ªç’°ç›´åˆ°</span>
                        <div class="slot" data-accept="sensor">(æ¢ä»¶?)</div>
                        <span class="trash-btn" onclick="removeNode(this, event)">âœ–</span>
                    </div>
                    <div class="block-body" data-type="container"></div>
                `;
            }
            container.appendChild(div);
            setupSlots(div);
        } else if (type === 'action') {
            const div = document.createElement('div');
            div.className = 'chip c-action';
            div.innerHTML = `<span>${TEXT_MAP[val]}</span> <span class="trash-btn" onclick="removeNode(this, event)" style="margin-left:auto">âœ–</span>`;
            div.dataset.action = val; div.dataset.logic = 'action';
            container.appendChild(div);
        }
    }

    function addElseIf(btn) {
        const parentBlock = btn.closest('.block-struct');
        const newRow = document.createElement('div');
        newRow.className = 'branch-row'; newRow.dataset.branch = 'elseif';
        newRow.innerHTML = `
            <div class="block-header">
                <span style="color:var(--cyan)">ğŸ”· å¦å‰‡å¦‚æœ</span>
                <div class="slot" data-accept="sensor">(æ¢ä»¶?)</div>
                <span class="trash-btn" onclick="removeNode(this, event)">âœ–</span>
            </div>
            <div class="block-body" data-type="container"></div>
        `;
        parentBlock.insertBefore(newRow, btn);
        setupSlots(newRow);
    }

    function setupSlots(parent) {
        parent.querySelectorAll('.slot').forEach(slot => {
            slot.dataset.init = "true";
            slot.ondragover = (e) => { e.preventDefault(); slot.classList.add('drag-hover'); };
            slot.ondragleave = () => slot.classList.remove('drag-hover');
            slot.ondrop = (e) => {
                e.preventDefault(); e.stopPropagation(); slot.classList.remove('drag-hover');
                if (e.dataTransfer.getData("type") !== 'sensor') return;
                const val = e.dataTransfer.getData("val");
                slot.innerHTML = `<span style="color:var(--cyan)">${TEXT_MAP[val]}</span>`;
                slot.dataset.val = val; slot.classList.add('filled');
            };
            slot.onclick = () => { slot.innerHTML = '(æ¢ä»¶?)'; delete slot.dataset.val; slot.classList.remove('filled'); };
        });
    }

    function parseLogic(container) {
        const steps = [];
        for (let child of container.children) {
            const logic = child.dataset.logic;
            if (logic === 'action') {
                steps.push({ type: 'action', act: child.dataset.action });
            } else if (logic === 'if') {
                const branches = [];
                let elseBody = [];
                for (let row of child.children) {
                    if (row.classList.contains('branch-row')) {
                        const bType = row.dataset.branch;
                        const slot = row.querySelector('.slot');
                        const bodyContainer = row.querySelector('.block-body');
                        if (bType === 'if' || bType === 'elseif') {
                            const sensor = slot ? slot.dataset.val : null;
                            const body = parseLogic(bodyContainer);
                            branches.push({ sensor, body });
                        } else if (bType === 'else') {
                            elseBody = parseLogic(bodyContainer);
                        }
                    }
                }
                steps.push({ type: 'multi-if', branches, elseBody });
            } else if (logic === 'while') {
                const sensor = child.querySelector('.slot').dataset.val;
                const body = parseLogic(child.querySelector('.block-body'));
                steps.push({ type: 'while', sensor, body });
            }
        }
        return steps;
    }

    // --- å¼•æ“åŸ·è¡Œå€ (ä¿®æ­£ç‰ˆ) ---
    async function runCode() {
        if (isRunning) return;
        const root = document.getElementById('root-container');
        const logicTree = parseLogic(root);
        if (logicTree.length === 0) { alert("è«‹å…ˆæ‹–å…¥ç©æœ¨ï¼"); return; }
        
        localStorage.setItem(KEY_CODE, root.innerHTML);

        // [Fix] ç”Ÿæˆæ–°çš„åŸ·è¡Œ ID
        activeExecId++; 
        const currentExecId = activeExecId;

        isRunning = true;
        log("--- é–‹å§‹åŸ·è¡Œ ---");
        
        let i = 0;
        let cycles = 0; 

        while (i < runtimeMap.length) {
            // æª¢æŸ¥ IDï¼Œå¦‚æœä¸ç¬¦å‰‡ç«‹åˆ»åœæ­¢
            if (activeExecId !== currentExecId) return;

            cycles++;
            if(cycles > 200) { log("ç³»çµ±å¼·åˆ¶åœæ­¢ï¼šå¾ªç’°éä¹…", 'l-err'); isRunning = false; return; }

            document.getElementById('belt').style.transform = `translateX(${-i * 100}px)`;
            
            const objData = runtimeMap[i];
            log(`[Pos ${i}] æƒæ: ${OBJ[objData.t].name}`);
            await sleep(500);
            if (activeExecId !== currentExecId) return; // å†æ¬¡æª¢æŸ¥
            
            if (objData.t === 9) {
                log("ä»»å‹™å®Œæˆï¼", 'l-ok'); setTimeout(() => nextLevel(), 1000); isRunning = false; return;
            }

            // å‚³é currentExecId é€²å…¥éæ­¸
            const res = await executeBlock(logicTree, objData, i, currentExecId);
            
            if (res === 'stop') return; // æ¥æ”¶åˆ°åœæ­¢ä¿¡è™Ÿ
            if (res === 'crash') {
                log("ç„¡äººæ©Ÿææ¯€ï¼", 'l-err'); alert("ä»»å‹™å¤±æ•—ï¼"); isRunning = false; return;
            } else if (res === 'moved') {
                i++;
            } else {
                log("ç­‰å¾…ä¸‹ä¸€æŒ‡ä»¤...", 'l-warn');
                await sleep(200);
            }
        }
        isRunning = false;
    }

    async function executeBlock(steps, obj, idx, execId) {
        if (activeExecId !== execId) return 'stop';

        for (let step of steps) {
            if (activeExecId !== execId) return 'stop';

            if (step.type === 'action') {
                const r = await performAction(step.act, obj, idx, execId);
                if (r === 'moved' || r === 'crash' || r === 'stop') return r;
                if (r === 'continue') continue;
            }
            else if (step.type === 'multi-if') {
                let matched = false;
                for (let branch of step.branches) {
                    if (checkSensor(branch.sensor, obj)) {
                        matched = true;
                        const r = await executeBlock(branch.body, obj, idx, execId);
                        if (r !== 'pass') return r;
                        break;
                    }
                }
                if (!matched) {
                    const r = await executeBlock(step.elseBody, obj, idx, execId);
                    if (r !== 'pass') return r;
                }
            }
            else if (step.type === 'while') {
                let safety = 0;
                while (checkSensor(step.sensor, obj)) {
                    if (activeExecId !== execId) return 'stop';
                    safety++; if (safety > 15) return 'crash';
                    log(`å¾ªç’°ä¸­...(${TEXT_MAP[step.sensor]})`);
                    const r = await executeBlock(step.body, obj, idx, execId);
                    if (r === 'moved' || r === 'crash' || r === 'stop') return r;
                    await sleep(400);
                }
            }
        }
        return 'pass';
    }

    async function performAction(act, obj, idx, execId) {
        if (activeExecId !== execId) return 'stop';
        log(`åŸ·è¡Œ: ${TEXT_MAP[act]}`);
        animateDrone(act);
        await sleep(300);
        if (activeExecId !== execId) return 'stop';

        if (act === 'move') {
            if (obj.t === 0) return 'moved';
            if ((obj.hp && obj.hp > 0) || [1,2,3,4,5].includes(obj.t)) return 'crash';
            return 'moved';
        }
        if (act === 'laser') {
            if (obj.s) { log("è­·ç›¾åå½ˆï¼", 'l-err'); return 'continue'; }
            else if (obj.hp) {
                obj.hp--; updateVisual(idx, obj); log(`å‘½ä¸­ HP:${obj.hp}`, 'l-warn');
                if (obj.hp <= 0) { obj.t = 0; updateVisual(idx, obj); }
                return 'continue';
            }
            else if (obj.t === 2) { 
                obj.t = 0; 
                updateVisual(idx, obj); 
                log("æ•µæ©Ÿæ‘§æ¯€", 'l-ok'); 
                return 'continue'; 
            }
        }
        else if (act === 'emp') { 
            if(obj.s){ obj.s=false; updateVisual(idx, obj); log("è­·ç›¾ç™±ç˜“", 'l-warn'); }
            return 'continue';
        }
        else if (act === 'jump') { return (obj.t===1)? 'moved' : 'crash'; }
        else if (act === 'key_r' && obj.t===3) { obj.t=0; updateVisual(idx, obj); log("ç´…é–€é–‹å•Ÿ", 'l-ok'); return 'continue'; }
        else if (act === 'key_b' && obj.t===4) { obj.t=0; updateVisual(idx, obj); log("è—é–€é–‹å•Ÿ", 'l-ok'); return 'continue'; }
        
        return 'continue';
    }

    function checkSensor(sensor, obj) {
        if (!sensor) return false;
        if (sensor === 'enemy') return (obj.t === 2 || obj.t === 4) && (!obj.hp || obj.hp > 0);
        if (sensor === 'rock') return (obj.t === 1 || obj.t === 5) && (!obj.hp || obj.hp > 0);
        if (sensor === 'shield') return obj.s === true;
        if (sensor === 'door_r') return obj.t === 3;
        if (sensor === 'door_b') return obj.t === 4;
        if (sensor === 'clear') return obj.t !== 0;
        return false;
    }

    function updateVisual(idx, obj) {
        const cell = document.getElementById(`cell-${idx}`);
        if (!cell) return; // é˜²æ­¢é‡ç½®å¾Œæ‰¾ä¸åˆ°å…ƒç´ å ±éŒ¯
        if (obj.hp !== undefined) {
            const bar = cell.querySelector('.hp-val');
            let max = (obj.t === 5) ? 3 : 5;
            if (bar) bar.style.width = `${(obj.hp/max)*100}%`;
        }
        const badge = cell.querySelector('.status-badge');
        if (badge) badge.style.display = obj.s ? 'block' : 'none';
        if (obj.t === 0) {
            cell.querySelector('.obj-vis').innerText = '';
            if(cell.querySelector('.hp-bar')) cell.querySelector('.hp-bar').style.display = 'none';
            if(badge) badge.style.display = 'none';
        }
    }

    function animateDrone(act) {
        const d = document.querySelector('.scanner-frame'); d.style.transition = '0.1s';
        if (act === 'laser' || act === 'emp') d.style.borderColor = 'red';
        else if (act === 'move') d.style.transform = 'translate(-40%, -50%)';
        else if (act === 'jump') d.style.transform = 'translate(-50%, -65%)';
        setTimeout(() => { d.style.borderColor = 'var(--green)'; d.style.transform = 'translate(-50%, -50%)'; }, 200);
    }

    function log(msg, cls) { const c = document.getElementById('console'); c.innerHTML += `<div class="log-line ${cls||''}">${msg}</div>`; c.scrollTop = c.scrollHeight; }
    
    function nextLevel() { 
        if(curLvlIdx < LEVELS.length-1){ 
            if(confirm("ä¸‹ä¸€é—œï¼Ÿ")) loadLevel(curLvlIdx+1, false); 
        } else alert("é€šé—œï¼"); 
    }
    
    function resetLevel() { 
        // [Fix] å¢åŠ  IDï¼Œè®“èˆŠçš„ç¨‹å¼å¾ªç’°å› ç‚º ID ä¸ç¬¦è€Œè‡ªå‹•é€€å‡º
        activeExecId++;
        isRunning = false; 
        loadLevel(curLvlIdx, true); 
    }
    
    const sleep = ms => new Promise(r => setTimeout(r, ms));

</script>
</body>
</html>
